{% extends "organizer/base.html" %}

{% block dashboard_title %}{% if challenge %}Edit Challenge{% else %}Create Challenge{% endif %}{% endblock %}

{% block extra_css %}
<style>
  .form-section {
    background: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .form-section-title {
    color: #4e31aa;
    font-weight: 600;
    margin-bottom: 15px;
    font-size: 1.1rem;
    border-bottom: 2px solid #f8f9fa;
    padding-bottom: 8px;
  }
  
  .form-label {
    color: #2c2c2c !important;
    font-weight: 500;
    margin-bottom: 5px;
  }
  
  .form-control, .form-select {
    background-color: #ffffff !important;
    border: 1px solid #ced4da !important;
    color: #495057 !important;
    border-radius: 4px;
  }
  
  .form-control:focus, .form-select:focus {
    background-color: #ffffff !important;
    border-color: #4e31aa !important;
    color: #495057 !important;
    box-shadow: 0 0 0 0.25rem rgba(78, 49, 170, 0.25) !important;
  }
  
  .form-text {
    color: #6c757d !important;
    font-size: 0.9rem;
  }
  
  .required::after {
    content: " *";
    color: #e74c3c;
  }
  
  .btn-primary {
    background-color: #4e31aa !important;
    border-color: #4e31aa !important;
    color: #ffffff !important;
  }
  
  .btn-primary:hover {
    background-color: #3a2683 !important;
    border-color: #3a2683 !important;
    color: #ffffff !important;
  }
  
  .invalid-feedback {
    display: block !important;
    color: #e74c3c !important;
    font-size: 0.9rem;
    margin-top: 5px;
  }
  
  .alert {
    border-radius: 8px;
    border: none;
    padding: 15px;
  }
  
  .alert-danger {
    background-color: rgba(231, 76, 60, 0.1) !important;
    border-left: 4px solid #e74c3c !important;
    color: #c0392b !important;
  }
  
  .alert-success {
    background-color: rgba(46, 204, 113, 0.1) !important;
    border-left: 4px solid #2ecc71 !important;
    color: #27ae60 !important;
  }
  
  .card {
    background-color: #ffffff !important;
    color: #2c2c2c !important;
  }
  
  .card-header {
    background-color: #f8f9fa !important;
    color: #2c2c2c !important;
  }
  
  .card-title {
    color: #4e31aa !important;
  }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header">
          <h3 class="card-title mb-0">
            <i class="fas {% if challenge %}fa-edit{% else %}fa-plus{% endif %} me-2"></i>
            {% if challenge %}Edit Challenge: {{ challenge.name }}{% else %}Create New Challenge{% endif %}
          </h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <!-- Non-field errors -->
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
          {{ error }}
        {% endfor %}
      </div>
    {% endif %}
    
    <div class="row">
      <div class="col-lg-8">
        <!-- Basic Information -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="fas fa-info-circle me-2"></i>
            Basic Information
          </h4>
          
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label for="{{ form.name.id_for_label }}" class="form-label required">Challenge Name</label>
                {{ form.name }}
                {% if form.name.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.name.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="mb-3">
                <label for="{{ form.value.id_for_label }}" class="form-label required">Points</label>
                {{ form.value }}
                {% if form.value.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.value.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label required">Description</label>
            {{ form.description }}
            {% if form.description.errors %}
              <div class="invalid-feedback">
                {% for error in form.description.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
            <div class="form-text">You can use Markdown formatting. HTML is also supported.</div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="{{ form.category.id_for_label }}" class="form-label required">Category</label>
                {{ form.category }}
                {% if form.category.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.category.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="mb-3">
                <label for="{{ form.event.id_for_label }}" class="form-label required">Event</label>
                {{ form.event }}
                {% if form.event.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.event.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Scoring Configuration -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="fas fa-trophy me-2"></i>
            Scoring Configuration
          </h4>
          
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="{{ form.initial_value.id_for_label }}" class="form-label">Initial Value</label>
                {{ form.initial_value }}
                {% if form.initial_value.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.initial_value.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">For dynamic scoring</div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="mb-3">
                <label for="{{ form.min_value.id_for_label }}" class="form-label">Minimum Value</label>
                {{ form.min_value }}
                {% if form.min_value.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.min_value.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">Minimum points possible</div>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="mb-3">
                <label for="{{ form.decay.id_for_label }}" class="form-label">Decay Factor</label>
                {{ form.decay }}
                {% if form.decay.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.decay.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">Score reduction rate (0.01-1.0)</div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="{{ form.decay_threshold.id_for_label }}" class="form-label">Decay Threshold</label>
                {{ form.decay_threshold }}
                {% if form.decay_threshold.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.decay_threshold.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">Solves before decay starts</div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="mb-3">
                <label for="{{ form.max_attempts.id_for_label }}" class="form-label">Max Attempts</label>
                {{ form.max_attempts }}
                {% if form.max_attempts.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.max_attempts.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
                <div class="form-text">0 = unlimited attempts</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Flags Section -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="fas fa-flag me-2"></i>
            Flags
          </h4>
          
          <div id="flags-container">
            {% if challenge.flags.all %}
              {% for flag in challenge.flags.all %}
                <div class="flag-item mb-3" data-flag-id="{{ flag.id }}">
                  <div class="row">
                    <div class="col-md-8">
                      <input type="text" class="form-control" name="flag_{{ flag.id }}" value="{{ flag.flag }}" placeholder="Enter flag value" required>
                    </div>
                    <div class="col-md-3">
                      <select class="form-select" name="flag_type_{{ flag.id }}">
                        <option value="static" {% if flag.type == 'static' %}selected{% endif %}>Static</option>
                        <option value="regex" {% if flag.type == 'regex' %}selected{% endif %}>Regex</option>
                      </select>
                    </div>
                    <div class="col-md-1">
                      <button type="button" class="btn btn-outline-danger btn-sm remove-flag" onclick="removeFlag(this)">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="flag-item mb-3">
                <div class="row">
                  <div class="col-md-8">
                    <input type="text" class="form-control" name="flag_1" placeholder="Enter flag value" required>
                  </div>
                  <div class="col-md-3">
                    <select class="form-select" name="flag_type_1">
                      <option value="static">Static</option>
                      <option value="regex">Regex</option>
                    </select>
                  </div>
                  <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-flag" onclick="removeFlag(this)" disabled>
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
          
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addFlag()">
            <i class="fas fa-plus me-2"></i>
            Add Another Flag
          </button>
          <div class="form-text mt-2">Add multiple flags for this challenge. At least one flag is required.</div>
        </div>

        <!-- Hints Section -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="fas fa-lightbulb me-2"></i>
            Hints
          </h4>
          
          <div id="hints-container">
            {% if challenge.hints.all %}
              {% for hint in challenge.hints.all %}
                <div class="hint-item mb-3" data-hint-id="{{ hint.id }}">
                  <div class="row">
                    <div class="col-md-7">
                      <textarea class="form-control" name="hint_{{ hint.id }}" rows="2" placeholder="Enter hint content">{{ hint.content }}</textarea>
                    </div>
                    <div class="col-md-3">
                      <input type="number" class="form-control" name="hint_cost_{{ hint.id }}" value="{{ hint.cost }}" placeholder="Cost" min="0">
                    </div>
                    <div class="col-md-2">
                      <button type="button" class="btn btn-outline-danger btn-sm remove-hint" onclick="removeHint(this)">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          </div>
          
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addHint()">
            <i class="fas fa-plus me-2"></i>
            Add Hint
          </button>
          <div class="form-text mt-2">Hints are optional. Players can purchase hints for a cost in points.</div>
        </div>

        <!-- Files Section -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="fas fa-file me-2"></i>
            Challenge Files
          </h4>
          
          <div id="files-container">
            {% if challenge.challenge_files.all %}
              {% for file in challenge.challenge_files.all %}
                <div class="file-item mb-3" data-file-id="{{ file.id }}">
                  <div class="row">
                    <div class="col-md-8">
                      <div class="existing-file">
                        <i class="fas fa-file me-2"></i>
                        <a href="{{ file.file.url }}" target="_blank">{{ file.file.name }}</a>
                        <span class="text-muted ms-2">({{ file.file.size|filesizeformat }})</span>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="file_visible_{{ file.id }}" {% if file.is_visible %}checked{% endif %}>
                        <label class="form-check-label">Visible</label>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <button type="button" class="btn btn-outline-danger btn-sm remove-file" onclick="removeFile(this, {{ file.id }})">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          </div>
          
          <div id="new-files-container">
            <div class="file-upload-item mb-3">
              <div class="row">
                <div class="col-md-8">
                  <input type="file" class="form-control" name="new_files" accept=".txt,.pdf,.zip,.tar.gz,.jpg,.png,.gif">
                </div>
                <div class="col-md-2">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="new_file_visible" checked>
                    <label class="form-check-label">Visible</label>
                  </div>
                </div>
                <div class="col-md-2">
                  <button type="button" class="btn btn-outline-danger btn-sm remove-new-file" onclick="removeNewFile(this)" disabled>
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addFileUpload()">
            <i class="fas fa-plus me-2"></i>
            Add Another File
          </button>
          <div class="form-text mt-2">Upload files that players can download for this challenge.</div>
        </div>
      </div>

      <div class="col-lg-4">
        <!-- Settings -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="fas fa-cog me-2"></i>
            Challenge Settings
          </h4>
          
          <div class="mb-3">
            <label for="{{ form.difficulty.id_for_label }}" class="form-label">Difficulty</label>
            {{ form.difficulty }}
            {% if form.difficulty.errors %}
              <div class="invalid-feedback">
                {% for error in form.difficulty.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
            <div class="form-text">1 = Easy, 5 = Hard</div>
          </div>
          
          <div class="mb-3">
            <label for="{{ form.type.id_for_label }}" class="form-label">Type</label>
            {{ form.type }}
            {% if form.type.errors %}
              <div class="invalid-feedback">
                {% for error in form.type.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
          </div>
          
          <div class="mb-3">
            <label for="{{ form.state.id_for_label }}" class="form-label">State</label>
            {{ form.state }}
            {% if form.state.errors %}
              <div class="invalid-feedback">
                {% for error in form.state.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
          </div>
          
          <div class="mb-3">
            <label for="{{ form.flag_logic.id_for_label }}" class="form-label">Flag Logic</label>
            {{ form.flag_logic }}
            {% if form.flag_logic.errors %}
              <div class="invalid-feedback">
                {% for error in form.flag_logic.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
            <div class="form-text">How multiple flags are validated</div>
          </div>
          
          <div class="form-check">
            {{ form.is_visible }}
            <label class="form-check-label" for="{{ form.is_visible.id_for_label }}">
              Visible to participants
            </label>
            {% if form.is_visible.errors %}
              <div class="invalid-feedback">
                {% for error in form.is_visible.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="form-section">
          <h4 class="form-section-title">
            <i class="fas fa-bolt me-2"></i>
            Quick Actions
          </h4>
          
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>
              {% if challenge %}Update Challenge{% else %}Create Challenge{% endif %}
            </button>
            
            {% if challenge %}
              <a href="{% url 'organizer:challenge_detail' challenge.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-eye me-2"></i>
                View Challenge
              </a>
            {% endif %}
            
            <a href="{% url 'organizer:challenges' %}" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left me-2"></i>
              Back to Challenges
            </a>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  let flagCounter = {% if challenge.flags.all %}{{ challenge.flags.all.count }}{% else %}1{% endif %};
  let hintCounter = {% if challenge.hints.all %}{{ challenge.hints.all.count }}{% else %}0{% endif %};
  let fileCounter = 1;

  // Flag Management
  function addFlag() {
    flagCounter++;
    const flagsContainer = document.getElementById('flags-container');
    const newFlagItem = document.createElement('div');
    newFlagItem.className = 'flag-item mb-3';
    newFlagItem.innerHTML = `
      <div class="row">
        <div class="col-md-8">
          <input type="text" class="form-control" name="flag_${flagCounter}" placeholder="Enter flag value" required>
        </div>
        <div class="col-md-3">
          <select class="form-select" name="flag_type_${flagCounter}">
            <option value="static">Static</option>
            <option value="regex">Regex</option>
          </select>
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-outline-danger btn-sm remove-flag" onclick="removeFlag(this)">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    `;
    flagsContainer.appendChild(newFlagItem);
    updateFlagRemoveButtons();
  }

  function removeFlag(button) {
    const flagItem = button.closest('.flag-item');
    flagItem.remove();
    updateFlagRemoveButtons();
  }

  function updateFlagRemoveButtons() {
    const flagItems = document.querySelectorAll('.flag-item');
    flagItems.forEach((item, index) => {
      const removeButton = item.querySelector('.remove-flag');
      removeButton.disabled = flagItems.length === 1;
    });
  }

  // Hint Management
  function addHint() {
    hintCounter++;
    const hintsContainer = document.getElementById('hints-container');
    const newHintItem = document.createElement('div');
    newHintItem.className = 'hint-item mb-3';
    newHintItem.innerHTML = `
      <div class="row">
        <div class="col-md-7">
          <textarea class="form-control" name="hint_${hintCounter}" rows="2" placeholder="Enter hint content"></textarea>
        </div>
        <div class="col-md-3">
          <input type="number" class="form-control" name="hint_cost_${hintCounter}" placeholder="Cost" min="0">
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-outline-danger btn-sm remove-hint" onclick="removeHint(this)">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    `;
    hintsContainer.appendChild(newHintItem);
  }

  function removeHint(button) {
    const hintItem = button.closest('.hint-item');
    hintItem.remove();
  }

  // File Management
  function addFileUpload() {
    fileCounter++;
    const newFilesContainer = document.getElementById('new-files-container');
    const newFileItem = document.createElement('div');
    newFileItem.className = 'file-upload-item mb-3';
    newFileItem.innerHTML = `
      <div class="row">
        <div class="col-md-8">
          <input type="file" class="form-control" name="new_files" accept=".txt,.pdf,.zip,.tar.gz,.jpg,.png,.gif">
        </div>
        <div class="col-md-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="new_file_visible" checked>
            <label class="form-check-label">Visible</label>
          </div>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-outline-danger btn-sm remove-new-file" onclick="removeNewFile(this)">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
    `;
    newFilesContainer.appendChild(newFileItem);
    updateNewFileRemoveButtons();
  }

  function removeNewFile(button) {
    const fileItem = button.closest('.file-upload-item');
    fileItem.remove();
    updateNewFileRemoveButtons();
  }

  function updateNewFileRemoveButtons() {
    const fileItems = document.querySelectorAll('.file-upload-item');
    fileItems.forEach((item, index) => {
      const removeButton = item.querySelector('.remove-new-file');
      removeButton.disabled = fileItems.length === 1;
    });
  }

  function removeFile(button, fileId) {
    if (confirm('Are you sure you want to remove this file?')) {
      const fileItem = button.closest('.file-item');
      // Add a hidden input to mark this file for deletion
      const deleteInput = document.createElement('input');
      deleteInput.type = 'hidden';
      deleteInput.name = 'delete_file_' + fileId;
      deleteInput.value = 'true';
      document.querySelector('form').appendChild(deleteInput);
      fileItem.remove();
    }
  }

  // Auto-fill initial_value when value changes
  document.addEventListener('DOMContentLoaded', function() {
    const valueField = document.getElementById('{{ form.value.id_for_label }}');
    const initialValueField = document.getElementById('{{ form.initial_value.id_for_label }}');
    const minValueField = document.getElementById('{{ form.min_value.id_for_label }}');
    
    if (valueField) {
      valueField.addEventListener('input', function() {
        if (!initialValueField.value) {
          initialValueField.value = this.value;
        }
        if (!minValueField.value) {
          minValueField.value = Math.floor(this.value / 2);
        }
      });
    }

    // Initialize button states
    updateFlagRemoveButtons();
    updateNewFileRemoveButtons();
  });

  // Form submission handler
  document.querySelector('form').addEventListener('submit', function(e) {
    // Validate that at least one flag is provided
    const flagInputs = document.querySelectorAll('input[name^="flag_"]');
    let hasValidFlag = false;
    
    flagInputs.forEach(input => {
      if (input.value.trim()) {
        hasValidFlag = true;
      }
    });
    
    if (!hasValidFlag) {
      e.preventDefault();
      alert('At least one flag is required for this challenge.');
      return false;
    }
  });
</script>
{% endblock %}

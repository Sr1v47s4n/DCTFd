{% extends "superadmin/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}System Statistics | Admin Dashboard{% endblock %}

{% block dashboard_title %}System Statistics{% endblock %}

{% block dashboard_content %}
<div class="row mb-4">
  <div class="col-md-12">
    <div class="alert alert-info">
      <i class="fas fa-info-circle me-2"></i> Platform statistics dashboard showing real-time information about user activity, challenge performance, and submissions.
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col">
    <div class="stat-card bg-primary text-white h-100">
      <div class="stat-icon"><i class="fas fa-users fa-2x"></i></div>
      <div class="stat-value">{{ user_count|default:"0" }}</div>
      <div class="stat-label">Total Users</div>
    </div>
  </div>
  <div class="col">
    <div class="stat-card bg-success text-white h-100">
      <div class="stat-icon"><i class="fas fa-user-friends fa-2x"></i></div>
      <div class="stat-value">{{ team_count|default:"0" }}</div>
      <div class="stat-label">Teams</div>
    </div>
  </div>
  <div class="col">
    <div class="stat-card bg-danger text-white h-100">
      <div class="stat-icon"><i class="fas fa-flag fa-2x"></i></div>
      <div class="stat-value">{{ challenge_count|default:"0" }}</div>
      <div class="stat-label">Challenges</div>
    </div>
  </div>
  <div class="col">
    <div class="stat-card bg-info text-white h-100">
      <div class="stat-icon"><i class="fas fa-paper-plane fa-2x"></i></div>
      <div class="stat-value">{{ submission_count|default:"0" }}</div>
      <div class="stat-label">Submissions</div>
    </div>
  </div>
  <div class="col">
    <div class="stat-card bg-warning text-dark h-100">
      <div class="stat-icon"><i class="fas fa-tags fa-2x"></i></div>
      <div class="stat-value">{{ category_count|default:"0" }}</div>
      <div class="stat-label">Categories</div>
    </div>
  </div>
  <div class="col">
    <div class="stat-card bg-secondary text-white h-100">
      <div class="stat-icon"><i class="fas fa-check-circle fa-2x"></i></div>
      <div class="stat-value">{{ success_rate|default:"0" }}%</div>
      <div class="stat-label">Success Rate</div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card dashboard-card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-user-plus me-2"></i> User Registration Trend</h5>
        <span class="badge bg-primary">Last 30 Days</span>
      </div>
      <div class="card-body">
        <div class="chart-container" style="position: relative; height:300px;">
          <canvas id="registrationChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card dashboard-card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i> Submission Activity</h5>
        <span class="badge bg-primary">Last 30 Days</span>
      </div>
      <div class="card-body">
        <div class="chart-container" style="position: relative; height:300px;">
          <canvas id="submissionChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card dashboard-card h-100">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-trophy me-2"></i> Top Teams</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Team</th>
                <th>Members</th>
                <th>Solves</th>
              </tr>
            </thead>
            <tbody>
              {% for team in top_teams %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>
                    <a href="{% url 'superadmin:team_detail' team.id %}">{{ team.name }}</a>
                  </td>
                  <td>{{ team.members.count }}</td>
                  <td>{{ team.solve_count }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center">No teams found</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card dashboard-card h-100">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-list me-2"></i> Recent Submissions</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Time</th>
                <th>User</th>
                <th>Challenge</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for sub in recent_submissions %}
                <tr>
                  <td>{{ sub.submitted_at|date:"M d, H:i" }}</td>
                  <td>
                    <a href="{% url 'superadmin:user_detail' sub.user.id %}">{{ sub.user.username }}</a>
                    {% if sub.team %}
                    <span class="badge bg-secondary">{{ sub.team.name }}</span>
                    {% endif %}
                  </td>
                  <td>{{ sub.challenge.name }}</td>
                  <td>
                    {% if sub.is_correct %}
                    <span class="badge bg-success">Correct</span>
                    {% else %}
                    <span class="badge bg-danger">Incorrect</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center">No recent submissions</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="text-center mt-3">
          <a href="{% url 'superadmin:submissions' %}" class="btn btn-sm btn-primary">
            <i class="fas fa-search me-1"></i> View All Submissions
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card dashboard-card h-100">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Challenge Categories</h5>
      </div>
      <div class="card-body">
        <div class="chart-container" style="position: relative; height:300px;">
          <canvas id="categoriesChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card dashboard-card h-100">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-check-double me-2"></i> Solves by Category</h5>
      </div>
      <div class="card-body">
        <div class="chart-container" style="position: relative; height:300px;">
          <canvas id="solvesChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chartColors = [
      '#0d6efd', '#198754', '#ffc107', '#dc3545', '#6c757d', 
      '#0dcaf0', '#6610f2', '#fd7e14', '#20c997', '#d63384'
    ];
    
    // Registration Chart
    const regCtx = document.getElementById('registrationChart').getContext('2d');
    const regChart = new Chart(regCtx, {
      type: 'line',
      data: {
        labels: {{ registration_data.labels|safe }},
        datasets: [{
          label: 'User Registrations',
          data: {{ registration_data.counts|safe }},
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13, 110, 253, 0.1)',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      }
    });
    
    // Submission Chart
    const subCtx = document.getElementById('submissionChart').getContext('2d');
    const subChart = new Chart(subCtx, {
      type: 'line',
      data: {
        labels: {{ submission_data.labels|safe }},
        datasets: [{
          label: 'Submissions',
          data: {{ submission_data.counts|safe }},
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      }
    });
    
    // Categories Chart
    const catCtx = document.getElementById('categoriesChart').getContext('2d');
    const catChart = new Chart(catCtx, {
      type: 'doughnut',
      data: {
        labels: {{ category_challenges.labels|safe }},
        datasets: [{
          label: 'Challenges by Category',
          data: {{ category_challenges.counts|safe }},
          backgroundColor: chartColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
          }
        }
      }
    });
    
    // Solves Chart
    const solvesCtx = document.getElementById('solvesChart').getContext('2d');
    const solvesChart = new Chart(solvesCtx, {
      type: 'bar',
      data: {
        labels: {{ category_solves.labels|safe }},
        datasets: [{
          label: 'Solves by Category',
          data: {{ category_solves.counts|safe }},
          backgroundColor: chartColors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      }
    });
  });
</script>
{% endblock %}

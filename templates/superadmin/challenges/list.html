{% extends "superadmin/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Challenges | Admin Dashboard{% endblock %}

{% block dashboard_title %}Challenges{% endblock %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h4>Manage CTF Challenges</h4>
  <div>
    <a href="{% url 'superadmin:add_challenge' %}" class="btn btn-primary">
      <i class="fas fa-plus me-2"></i> Add Challenge
    </a>
  </div>
</div>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<div class="card dashboard-card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">All Challenges</h5>
    <div class="input-group" style="width: 300px;">
      <input type="text" id="challengeSearch" class="form-control" placeholder="Search challenges...">
      <button class="btn btn-outline-secondary" type="button">
        <i class="fas fa-search"></i>
      </button>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Points</th>
            <th>Solves</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if challenges %}
            {% for challenge in challenges %}
              <tr>
                <td>
                  <a href="{% url 'superadmin:challenge_detail' challenge.id %}" class="fw-bold text-decoration-none">
                    {{ challenge.name }}
                  </a>
                </td>
                <td>
                  <span class="badge bg-secondary">{{ challenge.category.name }}</span>
                </td>
                <td>{{ challenge.points }}</td>
                <td>{{ challenge.solved_count|default:"0" }}</td>
                <td>
                  {% if challenge.is_active %}
                    <span class="badge bg-success">Active</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactive</span>
                  {% endif %}
                </td>
                <td>
                  <div class="d-flex">
                    <a href="{% url 'superadmin:challenge_detail' challenge.id %}" class="btn btn-sm btn-outline-primary me-1">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a href="{% url 'superadmin:edit_challenge' challenge.id %}" class="btn btn-sm btn-outline-secondary me-1">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a href="{% url 'superadmin:delete_challenge' challenge.id %}" class="btn btn-sm btn-outline-danger">
                      <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="text-center py-4">
                <div class="d-flex flex-column align-items-center">
                  <i class="fas fa-flag fa-3x text-muted mb-3"></i>
                  <p class="mb-1">No challenges found</p>
                  <small class="text-muted">Create your first challenge to get started</small>
                  <a href="{% url 'superadmin:add_challenge' %}" class="btn btn-sm btn-primary mt-3">
                    <i class="fas fa-plus me-1"></i> Add Challenge
                  </a>
                </div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card dashboard-card mt-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Categories</h5>
    <div>
      <a href="{% url 'superadmin:categories' %}" class="btn btn-outline-primary btn-sm me-2">
        <i class="fas fa-cog me-1"></i> Manage All
      </a>
      <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
        <i class="fas fa-plus me-1"></i> Add Category
      </button>
    </div>
  </div>
  <div class="card-body">
    <div class="row">
      {% if categories %}
        {% for category in categories %}
          <div class="col-md-4 mb-3">
            <div class="card {% if category.is_hidden %}bg-light border-secondary{% endif %}">
              <div class="card-body">
                <h5 class="card-title">{{ category.name }}</h5>
                <p class="card-text text-muted small">{{ category.description|truncatechars:100 }}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge bg-primary fs-6">{{ category.challenge_set.count }} {% if category.challenge_set.count == 0 %}challenges{% elif category.challenge_set.count == 1 %}challenge{% else %}challenges{% endif %}</span>
                  {% if category.is_hidden %}
                    <span class="badge bg-secondary">Hidden</span>
                  {% endif %}
                  <div>
                    <a href="{% url 'superadmin:edit_category' category.id %}" class="btn btn-sm btn-outline-secondary">
                      <i class="fas fa-edit"></i>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="col-12 text-center py-4">
          <p class="text-muted">No categories found</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Challenge search functionality
    const searchInput = document.getElementById('challengeSearch');
    const tableRows = document.querySelectorAll('tbody tr');
    
    if (searchInput) {
      searchInput.addEventListener('keyup', function() {
        const searchTerm = searchInput.value.toLowerCase();
        
        tableRows.forEach(row => {
          const challengeName = row.querySelector('td:first-child').textContent.toLowerCase();
          const categoryName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
          
          if (challengeName.includes(searchTerm) || categoryName.includes(searchTerm)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });
      });
    }
    
    // Category form submission
    const addCategoryForm = document.getElementById('addCategoryForm');
    if (addCategoryForm) {
      addCategoryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(addCategoryForm);
        const errorAlert = document.getElementById('categoryFormError');
        errorAlert.classList.add('d-none');
        
        fetch("{% url 'superadmin:add_category' %}", {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
          },
          body: new URLSearchParams(formData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Refresh the page to show the new category
            window.location.reload();
          } else {
            // Show error message
            errorAlert.textContent = data.message || 'An error occurred while adding the category.';
            errorAlert.classList.remove('d-none');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          errorAlert.textContent = 'An unexpected error occurred.';
          errorAlert.classList.remove('d-none');
        });
      });
    }
  });
</script>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addCategoryForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="category_name" class="form-label">Name</label>
            <input type="text" class="form-control" id="category_name" name="name" required>
          </div>
          
          <div class="mb-3">
            <label for="category_description" class="form-label">Description</label>
            <textarea class="form-control" id="category_description" name="description" rows="3"></textarea>
            <div class="form-text">Optional description for this category</div>
          </div>
          
          <div class="alert alert-danger d-none" id="categoryFormError"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Category</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

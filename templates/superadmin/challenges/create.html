{% extends "superadmin/base.html" %}
{% load static %}
{% load i18n %}
{% load file_extras %}

{% block title %}Challenge Management | Admin Dashboard{% endblock %}

{% block dashboard_title %}Challenge Management{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="mb-4">
    <a href="{% url 'superadmin:challenges' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i> Back to Challenges
    </a>
  </div>
  
  <h2 class="mb-4">Create New Challenge</h2>
  
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

<div class="card dashboard-card">
  <div class="card-header">
    <h5 class="mb-0">Challenge Information</h5>
  </div>
  <div class="card-body">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="id_name" class="form-label">Challenge Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="id_name" name="name" required value="{{ form.name|default_if_none:'' }}">
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="id_category" class="form-label">Category <span class="text-danger">*</span></label>
            <select class="form-select" id="id_category" name="category" required>
              <option value="">Select a category</option>
              {% for category in categories %}
                <option value="{{ category.id }}" {% if form.category == category.id %}selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
            </select>
            <div class="form-text mt-1">
              <a href="#" data-bs-toggle="modal" data-bs-target="#quickAddCategoryModal">
                <i class="fas fa-plus-circle me-1"></i> Add New Category
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="id_value" class="form-label">Points <span class="text-danger">*</span></label>
            <input type="number" class="form-control" id="id_value" name="value" required value="{{ form.value|default_if_none:'' }}">
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="id_difficulty" class="form-label">Difficulty</label>
            <select class="form-select" id="id_difficulty" name="difficulty">
              <option value="1" {% if form.difficulty == 1 %}selected{% endif %}>Easy</option>
              <option value="2" {% if form.difficulty == 2 %}selected{% endif %}>Medium</option>
              <option value="3" {% if form.difficulty == 3 %}selected{% endif %}>Hard</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="mb-3">
        <label for="id_description" class="form-label">Description <span class="text-danger">*</span></label>
        <textarea class="form-control" id="id_description" name="description" rows="5" required>{{ form.description|default_if_none:'' }}</textarea>
        <div class="form-text">Markdown is supported. Provide a clear description of the challenge.</div>
      </div>
      
      <div class="mb-3">
        <label for="id_state" class="form-label">State</label>
        <select class="form-select" id="id_state" name="state">
          <option value="hidden" {% if form.state == "hidden" %}selected{% endif %}>Hidden</option>
          <option value="visible" {% if form.state == "visible" %}selected{% endif %}>Visible</option>
          <option value="locked" {% if form.state == "locked" %}selected{% endif %}>Locked</option>
        </select>
        <div class="form-text">The visibility state of the challenge.</div>
      </div>
      
      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="id_is_visible" name="is_visible" {% if form.is_visible %}checked{% endif %}>
        <label class="form-check-label" for="id_is_visible">Visible</label>
        <div class="form-text">If checked, this challenge will be visible to participants.</div>
      </div>
      
      <div class="mt-4 mb-4">
        <h5 class="border-bottom pb-2 mb-3">Flags</h5>
        
        <div id="flags-container">
          {{ formset.management_form }}
          
          {% for flag_form in formset %}
            <div class="card mb-3 flag-form">
              <div class="card-body">
                {% for hidden_field in flag_form.hidden_fields %}
                  {{ hidden_field }}
                {% endfor %}
                
                <div class="row mb-3">
                  <div class="col-md-8">
                    <label class="form-label">Flag Content <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="{{ flag_form.flag.html_name }}" id="{{ flag_form.flag.id_for_label }}" value="{{ flag_form.flag.value|default_if_none:'' }}">
                  </div>
                  
                  <div class="col-md-4">
                    <label class="form-label">Flag Type</label>
                    <select class="form-select" name="{{ flag_form.type.html_name }}" id="{{ flag_form.type.id_for_label }}">
                      <option value="static" {% if flag_form.type.value == 'static' %}selected{% endif %}>Static</option>
                      <option value="regex" {% if flag_form.type.value == 'regex' %}selected{% endif %}>Regex</option>
                    </select>
                  </div>
                </div>
                
                {% if flag_form.instance.pk %}
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="{{ flag_form.DELETE.id_for_label }}" name="{{ flag_form.DELETE.html_name }}">
                    <label class="form-check-label" for="{{ flag_form.DELETE.id_for_label }}">Delete this flag</label>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
        
        <button type="button" id="add-flag-btn" class="btn btn-outline-primary">
          <i class="fas fa-plus me-1"></i> Add Flag
        </button>
      </div>
      
      <div class="mt-4 mb-4">
        <h5 class="border-bottom pb-2 mb-3">Challenge Files</h5>
        
        <div id="files-container">
          {{ files_formset.management_form }}
          
          {% for file_form in files_formset %}
            <div class="card mb-3 file-form">
              <div class="card-body">
                {% for hidden_field in file_form.hidden_fields %}
                  {{ hidden_field }}
                {% endfor %}
                
                <div class="row mb-3">
                  <div class="col-md-12">
                    <label class="form-label">File</label>
                    <input type="file" class="form-control" name="{{ file_form.file.html_name }}" id="{{ file_form.file.id_for_label }}">
                    
                    {% if file_form.instance.pk and file_form.instance.file %}
                      <div class="mt-2">
                        <span class="badge bg-secondary me-1">Current file:</span>
                        <a href="{{ file_form.instance.file.url }}" target="_blank" class="text-decoration-none">
                          {{ file_form.instance.file.name|get_filename }}
                        </a>
                      </div>
                    {% endif %}
                  </div>
                </div>
                
                {% if file_form.instance.pk %}
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="{{ file_form.DELETE.id_for_label }}" name="{{ file_form.DELETE.html_name }}">
                    <label class="form-check-label" for="{{ file_form.DELETE.id_for_label }}">Delete this file</label>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
        
        <button type="button" id="add-file-btn" class="btn btn-outline-primary">
          <i class="fas fa-plus me-1"></i> Add File
        </button>
      </div>
      
      <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'superadmin:challenges' %}" class="btn btn-outline-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-1"></i> Save Challenge
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Quick Add Category Modal -->
<div class="modal fade" id="quickAddCategoryModal" tabindex="-1" aria-labelledby="quickAddCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quickAddCategoryModalLabel">Add New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="quick_category_name" class="form-label">Name</label>
          <input type="text" class="form-control" id="quick_category_name" required>
        </div>
        <div class="mb-3">
          <label for="quick_category_description" class="form-label">Description</label>
          <textarea class="form-control" id="quick_category_description" rows="2"></textarea>
          <div class="form-text">Optional description for this category</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveQuickCategoryBtn">Add Category</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Flag formset management
    const flagsContainer = document.getElementById('flags-container');
    const addFlagBtn = document.getElementById('add-flag-btn');
    const flagsManagementForm = document.querySelector('[name="flags-TOTAL_FORMS"]');
    
    if (addFlagBtn) {
      addFlagBtn.addEventListener('click', function() {
        const flagForms = document.querySelectorAll('.flag-form');
        const totalForms = flagForms.length;
        const newForm = flagForms[0].cloneNode(true);
        
        // Update IDs and names
        newForm.querySelectorAll('input, select').forEach(input => {
          const name = input.getAttribute('name');
          if (name) {
            input.setAttribute('name', name.replace(/flags-0-/, `flags-${totalForms}-`));
            input.setAttribute('id', input.getAttribute('id').replace(/flags-0-/, `flags-${totalForms}-`));
          }
          
          // Clear values
          if (input.type === 'text' || input.type === 'file') {
            input.value = '';
          }
          
          // Hide DELETE checkbox for new forms
          if (input.type === 'checkbox' && input.name.includes('DELETE')) {
            input.closest('.form-check').style.display = 'none';
          }
        });
        
        // Add the new form
        flagsContainer.appendChild(newForm);
        
        // Update total forms count
        flagsManagementForm.value = totalForms + 1;
      });
    }
    
    // File formset management
    const filesContainer = document.getElementById('files-container');
    const addFileBtn = document.getElementById('add-file-btn');
    const filesManagementForm = document.querySelector('[name="files-TOTAL_FORMS"]');
    
    if (addFileBtn) {
      addFileBtn.addEventListener('click', function() {
        const fileForms = document.querySelectorAll('.file-form');
        const totalForms = fileForms.length;
        const newForm = fileForms[0].cloneNode(true);
        
        // Update IDs and names
        newForm.querySelectorAll('input, select').forEach(input => {
          const name = input.getAttribute('name');
          if (name) {
            input.setAttribute('name', name.replace(/files-0-/, `files-${totalForms}-`));
            input.setAttribute('id', input.getAttribute('id').replace(/files-0-/, `files-${totalForms}-`));
          }
          
          // Clear values
          if (input.type === 'text' || input.type === 'file') {
            input.value = '';
          }
          
          // Hide DELETE checkbox for new forms
          if (input.type === 'checkbox' && input.name.includes('DELETE')) {
            input.closest('.form-check').style.display = 'none';
          }
        });
        
        // Remove "Current file" display if exists
        const currentFileInfo = newForm.querySelector('.mt-2');
        if (currentFileInfo) {
          currentFileInfo.remove();
        }
        
        // Add the new form
        filesContainer.appendChild(newForm);
        
        // Update total forms count
        filesManagementForm.value = totalForms + 1;
      });
    }
  });
</script>

<!-- Quick Add Category Modal Script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Quick Add Category
    document.getElementById('saveQuickCategoryBtn').addEventListener('click', function() {
      const name = document.getElementById('quick_category_name').value;
      const description = document.getElementById('quick_category_description').value;
      
      if (!name) {
        alert('Category name is required.');
        return;
      }
      
      // Use fetch to submit the form data
      fetch("{% url 'superadmin:add_category' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: new URLSearchParams({
          'name': name,
          'description': description,
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Add the new category to the dropdown
          const categorySelect = document.getElementById('id_category');
          const option = document.createElement('option');
          option.value = data.category_id;
          option.text = name;
          option.selected = true;
          categorySelect.appendChild(option);
          
          // Close the modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('quickAddCategoryModal'));
          modal.hide();
          
          // Show success message
          alert('Category added successfully!');
        } else {
          alert('Error: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the category.');
      });
    });
  });
</script>
{% endblock %}
